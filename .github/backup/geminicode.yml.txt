name: Gemini CLI with Strict Owner Check

on:
  issue_comment:
    types: [created]

jobs:
  run-gemini:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.body, '@gemini')
    steps:
      - uses: actions/checkout@v4
      
      - name: Check repository ownership
        id: check_ownership
        uses: actions/github-script@v7
        with:
          script: |
            const issueAuthor = context.payload.issue.user.login;
            
            // ãƒ¬ãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’å–å¾—
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            let isAuthorized = false;
            
            // å€‹äººãƒ¬ãƒã‚¸ãƒˆãƒªã®å ´åˆ
            if (repo.owner.type === 'User') {
              isAuthorized = issueAuthor === repo.owner.login;
              console.log(`å€‹äººãƒ¬ãƒã‚¸ãƒˆãƒª - ã‚ªãƒ¼ãƒŠãƒ¼: ${repo.owner.login}, ç™ºè¡Œè€…: ${issueAuthor}`);
            }
            // çµ„ç¹”ãƒ¬ãƒã‚¸ãƒˆãƒªã®å ´åˆ
            else if (repo.owner.type === 'Organization') {
              try {
                const { data: membership } = await github.rest.orgs.getMembershipForUser({
                  org: context.repo.owner,
                  username: issueAuthor
                });
                isAuthorized = membership.role === 'admin';
                console.log(`çµ„ç¹”ãƒ¬ãƒã‚¸ãƒˆãƒª - ç™ºè¡Œè€…ã®æ¨©é™: ${membership.role}`);
              } catch (error) {
                console.log(`çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
                isAuthorized = false;
              }
            }
            
            core.setOutput('is_authorized', isAuthorized);
            
            if (!isAuthorized) {
              console.log(`âŒ æ¨©é™ä¸è¶³: ${issueAuthor} ã¯ãƒ¬ãƒã‚¸ãƒˆãƒªã‚ªãƒ¼ãƒŠãƒ¼/ç®¡ç†è€…ã§ã¯ã‚ã‚Šã¾ã›ã‚“`);
            }
      
      - name: Extract and validate command
        if: steps.check_ownership.outputs.is_authorized == 'true'
        id: extract_command
        run: |
          COMMAND=$(echo '${{ github.event.issue.body }}' | grep -oP '(?<=@gemini ).*' | head -1 | tr -d '\n\r')
          if [ -z "$COMMAND" ]; then
            echo "âŒ @geminiã®å¾Œã«ã‚³ãƒãƒ³ãƒ‰ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          echo "GEMINI_COMMAND=$COMMAND" >> $GITHUB_ENV
          echo "âœ… å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰: $COMMAND"
      
      - name: Install Gemini CLI
        if: steps.check_ownership.outputs.is_authorized == 'true'
        run: npm install -g @google/gemini-cli
      
      - name: Execute Gemini CLI
        if: steps.check_ownership.outputs.is_authorized == 'true'
        id: run_gemini
        run: |
          echo "ğŸš€ Gemini CLIã‚’å®Ÿè¡Œä¸­..."
          OUTPUT=$(gemini "$GEMINI_COMMAND" 2>&1)
          echo "GEMINI_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      
      - name: Post results to issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const isAuthorized = '${{ steps.check_ownership.outputs.is_authorized }}' === 'true';
            const runSuccess = '${{ steps.run_gemini.outcome }}' === 'success';
            
            let body;
            if (!isAuthorized) {
              body = 'âŒ **ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦**\n\nã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ãƒ¬ãƒã‚¸ãƒˆãƒªã‚ªãƒ¼ãƒŠãƒ¼ã¾ãŸã¯çµ„ç¹”ç®¡ç†è€…ã®ã¿ãŒå®Ÿè¡Œã§ãã¾ã™ã€‚\n\n**ç™ºè¡Œè€…:** @${{ github.event.issue.user.login }}\n**æ¨©é™:** ä¸ååˆ†';
            } else if (runSuccess) {
              body = 'âœ… **Gemini CLIã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå®Œäº†**\n\n**å®Ÿè¡Œè€…:** @${{ github.event.issue.user.login }} âœ¨ (èªè¨¼æ¸ˆã¿ã‚ªãƒ¼ãƒŠãƒ¼)\n**ã‚³ãƒãƒ³ãƒ‰:** `${{ env.GEMINI_COMMAND }}`\n**å®Ÿè¡Œæ™‚åˆ»:** ' + new Date().toISOString() + '\n\n**å®Ÿè¡Œçµæœ:**\n```\n${{ env.GEMINI_OUTPUT }}\n```';
            } else {
              body = 'âŒ **å®Ÿè¡Œã‚¨ãƒ©ãƒ¼**\n\nGemini CLIã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nè©³ç´°ã¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ã”ç¢ºèªãã ã•ã„ã€‚\n\n**å®Ÿè¡Œè€…:** @${{ github.event.issue.user.login }}\n**ã‚³ãƒãƒ³ãƒ‰:** `${{ env.GEMINI_COMMAND }}`';
            }
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
